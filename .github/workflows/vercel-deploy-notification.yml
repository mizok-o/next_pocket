name: Vercel Deploy Notification

on:
  deployment_status:

jobs:
  notify-slack:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: PRæƒ…å ±ã¨assigneeå–å¾—
        uses: actions/github-script@v7
        id: get-pr
        with:
          script: |
            const branch = context.payload.deployment.ref;
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              const assignees = pr.assignees ? pr.assignees.map(a => a.login) : [];
              return {
                number: pr.number,
                title: pr.title,
                url: pr.html_url,
                assignees: assignees
              };
            }
            return null;

      - name: Slacké€šçŸ¥
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ*\n${{ steps.get-pr.outputs.result && fromJSON(steps.get-pr.outputs.result).assignees[0] && format('<@{0}>', fromJSON(steps.get-pr.outputs.result).assignees[0]) || '<!channel>' }} ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ:*\n`${{ github.event.deployment.ref }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ:*\n${{ github.event.deployment.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*é–¢é€£PR:*\n${{ steps.get-pr.outputs.result && fromJSON(steps.get-pr.outputs.result).title || 'ãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL:*\n<${{ github.event.deployment_status.target_url }}|ã‚µã‚¤ãƒˆã‚’ç¢ºèª>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "GitHubã§ç¢ºèª"
                      },
                      "url": "${{ steps.get-pr.outputs.result && fromJSON(steps.get-pr.outputs.result).url || github.event.repository.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}