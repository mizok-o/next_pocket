name: Vercel Deploy Notification

on:
  deployment_status:

jobs:
  notify-slack:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: PRæƒ…å ±ã¨assigneeå–å¾—
        uses: actions/github-script@v7
        id: get-pr
        with:
          script: |
            const branch = context.payload.deployment.ref;
            const sha = context.payload.deployment.sha;
            
            try {
              // Step 1: ã‚³ãƒŸãƒƒãƒˆSHAã‹ã‚‰é–¢é€£PRã‚’æ¤œç´¢
              const commitPRs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha
              });
              
              if (commitPRs.data.length > 0) {
                const pr = commitPRs.data[0];
                return {
                  number: pr.number,
                  title: pr.title,
                  url: pr.html_url,
                  branch: branch
                };
              }
              
              // Step 2: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰PRç•ªå·ã‚’æŠ½å‡º
              const commit = await github.rest.git.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha
              });
              
              const commitMessage = commit.data.message;
              const prMatch = commitMessage.match(/Merge pull request #(\d+)|#(\d+)/);
              
              if (prMatch) {
                const prNumber = prMatch[1] || prMatch[2];
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: parseInt(prNumber)
                });
                
                return {
                  number: pr.data.number,
                  title: pr.data.title,
                  url: pr.data.html_url,
                  branch: branch
                };
              }
              
              // Step 3: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æ¤œç´¢
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'all',
                sort: 'updated',
                direction: 'desc'
              });
              
              if (prs.data.length > 0) {
                const pr = prs.data[0];
                return {
                  number: pr.number,
                  title: pr.title,
                  url: pr.html_url,
                  branch: branch
                };
              }
              
            } catch (error) {
              console.log('PRæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error.message);
            }
            
            // PRãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã¯è¿”ã™
            return {
              number: null,
              title: null,
              url: null,
              branch: branch
            };

      - name: Slacké€šçŸ¥
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ*\n<!channel>\n\nğŸ“‹ *ãƒ–ãƒ©ãƒ³ãƒ:* `${{ fromJSON(steps.get-pr.outputs.result).branch }}` | *ç’°å¢ƒ:* ${{ github.event.deployment.environment }}${{ fromJSON(steps.get-pr.outputs.result).url && format('\nğŸ”— *PR:* <{0}|#{1} {2}>', fromJSON(steps.get-pr.outputs.result).url, fromJSON(steps.get-pr.outputs.result).number, fromJSON(steps.get-pr.outputs.result).title) || '' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸŒ ã‚µã‚¤ãƒˆã‚’ç¢ºèª"
                      },
                      "url": "${{ github.event.deployment_status.target_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“± GitHubã§ç¢ºèª"
                      },
                      "url": "${{ fromJSON(steps.get-pr.outputs.result).url || github.event.repository.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}